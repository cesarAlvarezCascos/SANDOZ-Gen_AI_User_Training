<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0" />
  <title>Training Agent — Chat</title>
  <script>
    // ⚙️ Ajusta esto a tu backend
    const API_URL = "http://localhost:8000/ask";
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* Scroll bonito y auto-ajuste */
    .scrollbar-thin::-webkit-scrollbar { width: 8px; }
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background: #cbd5e1; border-radius: 9999px;
    }
    .bubble { max-width: 80%; }
    .msg a { text-decoration: underline; }
    .prose pre { white-space: pre-wrap; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    pre { white-space: pre-wrap; word-wrap: break-word; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">
  <div class="max-w-3xl mx-auto px-4 py-6">
    <header class="flex items-center gap-3 mb-4">
      <div class="w-10 h-10 rounded-2xl bg-indigo-600 flex items-center justify-center text-white font-bold">STA</div>
      <div>
        <h1 class="text-xl font-semibold">Sandoz Training Agent</h1>
      </div>
    </header>

    <main id="chat" class="bg-white rounded-2xl shadow p-4 h-[70vh] overflow-y-auto scrollbar-thin space-y-4">
      <!-- Mensaje de bienvenida -->
      <div class="flex gap-3 items-start">
        <div class="w-9 h-9 rounded-xl bg-indigo-600 text-white flex items-center justify-center text-sm">STA</div>
        <div class="bubble bg-slate-100 rounded-2xl px-4 py-3 msg">
          <p class="text-sm">
            ¡Hola! Soy tu Training Agent. Hazme una pregunta e intentaré responder lo mejor posible.
            Las Fuentes y el bloque Citations aparecerán en un desplegable.
          </p>
        </div>
      </div>
    </main>

    <form id="composer" class="mt-4 flex items-end gap-2">
      <textarea id="input" rows="2" placeholder="Escribe tu pregunta… (Shift+Enter: salto de línea)"
        class="flex-1 rounded-xl border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-none"></textarea>
      <button id="send" type="submit"
        class="rounded-xl bg-indigo-600 text-white px-4 py-2 font-medium hover:bg-indigo-700 disabled:opacity-50">Enviar</button>
    </form>
  </div>

  <!-- Templates -->
  <template id="msg-user">
    <div class="flex gap-3 items-start justify-end">
      <div class="bubble bg-indigo-600 text-white rounded-2xl px-4 py-3 msg"></div>
      <div class="w-9 h-9 rounded-xl bg-slate-200 text-slate-600 flex items-center justify-center text-sm">Tú</div>
    </div>
  </template>

  <template id="msg-bot">
    <div class="flex gap-3 items-start">
      <div class="w-9 h-9 rounded-xl bg-indigo-600 text-white flex items-center justify-center text-sm">TA</div>
      <div class="bubble bg-slate-100 rounded-2xl px-4 py-3 msg w-full">
        <div class="answer prose prose-sm max-w-none"></div>

        <!-- Un único desplegable con Fuentes y Citations -->
        <details class="mt-3 sources-citations">
          <summary class="text-xs text-slate-500 cursor-pointer">Fuentes y Citations</summary>

          <!-- Fuentes -->
          <div class="mt-2">
            <div class="mono text-xs text-slate-700">Fuentes:</div>
            <ul class="sources list-disc pl-5 mt-1 text-xs text-slate-600"></ul>
          </div>

          <!-- Citations (JSON pretty) -->
          <div class="mt-3">
            <div class="mono text-xs text-slate-700">Citations:</div>
            <pre class="mono text-xs bg-white border border-slate-200 rounded-lg p-3 mt-1 overflow-x-auto citations-json"></pre>
          </div>
        </details>
      </div>
    </div>
  </template>

  <template id="msg-bot-loading">
    <div class="flex gap-3 items-start">
      <div class="w-9 h-9 rounded-xl bg-indigo-600 text-white flex items-center justify-center text-sm">TA</div>
      <div class="bubble bg-slate-100 rounded-2xl px-4 py-3 msg">
        <div class="flex items-center gap-2 text-sm text-slate-500">
          <svg class="animate-spin h-4 w-4" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
            <path class="opacity-75" fill="currentColor"
              d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
          </svg>
          Generando respuesta…
        </div>
      </div>
    </div>
  </template>

  <script>
    const chat = document.getElementById('chat');
    const input = document.getElementById('input');
    const form = document.getElementById('composer');
    const btn = document.getElementById('send');

    const tplUser = document.getElementById('msg-user');
    const tplBot = document.getElementById('msg-bot');
    const tplLoading = document.getElementById('msg-bot-loading');

    function appendUser(text) {
      const node = tplUser.content.cloneNode(true);
      node.querySelector('.msg').textContent = text;
      chat.appendChild(node);
      chat.scrollTop = chat.scrollHeight;
    }

    function appendLoading() {
      const node = tplLoading.content.cloneNode(true);
      chat.appendChild(node);
      chat.scrollTop = chat.scrollHeight;
      return chat.lastElementChild; // referencia para reemplazar
    }

    function appendBot(answerText, citations) {
      const node = tplBot.content.cloneNode(true);

      // 1) Pinta la respuesta "limpia": quitamos el bloque final "Fuentes: ..."
      const cleaned = (answerText || "").replace(/\n+Fuentes:\s*([\s\S]*)$/i, '').trim();
      node.querySelector('.answer').innerText = cleaned || ' ';

      // 2) Fuentes: pinta [n] nombre_de_archivo
      const ul = node.querySelector('.sources');
      (citations || []).forEach((c, i) => {
        const li = document.createElement('li');
        const name = (c && c.file_name)
          ? String(c.file_name)
          : '<unknown>';
        li.textContent = `[${i+1}] ${name}`;
        ul.appendChild(li);
      });

      // 3) Citations JSON pretty (exactamente como ask_local.py)
      const pre = node.querySelector('.citations-json');
      try {
        pre.textContent = JSON.stringify(citations || [], null, 2);
      } catch {
        pre.textContent = '[]';
      }

      // 4) UX: si hay citas, abrir el <details> por defecto
    //   if ((citations || []).length > 0) {
    //     const details = node.querySelector('details.sources-citations');
    //     if (details) details.open = true;
    //   }

      chat.appendChild(node);
      chat.scrollTop = chat.scrollHeight;
    }

    // Shift+Enter = salto de línea; Enter = enviar
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        form.dispatchEvent(new Event('submit'));
      }
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text) return;

      appendUser(text);
      input.value = '';
      input.style.height = 'auto';

      const loadingEl = appendLoading();
      btn.disabled = true;

      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            role: 'analyst',
            query: text,
            time_budget: 30,
            level: 2
          })
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        // El backend devuelve { answer: "...Fuentes:\n[...]...", citations: [...] }
        chat.removeChild(loadingEl);
        appendBot(data.answer || '', data.citations || []);
      } catch (err) {
        chat.removeChild(loadingEl);
        appendBot(
          "Lo siento, hubo un error al llamar a la API. Revisa que el servidor esté activo y CORS habilitado.",
          []
        );
        console.error(err);
      } finally {
        btn.disabled = false;
      }
    });

    // Autoresize del textarea
    const autoSize = () => {
      input.style.height = 'auto';
      input.style.height = Math.min(input.scrollHeight, 160) + 'px';
    };
    input.addEventListener('input', autoSize);
    autoSize();
  </script>
</body>
</html>
